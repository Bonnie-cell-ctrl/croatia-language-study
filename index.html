<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…‹è¯­åŠ©æ‰‹ V32 (ç»†èŠ‚æ‰“ç£¨ç‰ˆ)</title>
    <style>
        :root {
            --primary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f7f9fc;
            --sort-bg: #fff3cd;
        }
        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg); margin: 0; padding-top: 110px;
            color: #333; 
            /* é˜²æ­¢é•¿æŒ‰å‡ºç°ç³»ç»Ÿèœå•ï¼Œç¡®ä¿é•¿æŒ‰æ’åºåŠŸèƒ½æ­£å¸¸ */
            -webkit-touch-callout: none; user-select: none; -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* é¡¶éƒ¨ Header */
        .sticky-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000; padding: 15px; box-sizing: border-box;
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .header-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }
        
        .nav-controls { display: flex; gap: 8px; max-width: 800px; margin: 0 auto; align-items: center; }
        .nav-btn { 
            background: #f0f2f5; color: #555; border: none; 
            padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;
        }
        select { 
            flex: 1; padding: 10px; border: 1px solid #e1e4e8; border-radius: 10px; 
            font-size: 15px; text-align: center; text-align-last: center; background: white;
        }
        .notebook-btn {
            width: 25%; background: #eef2ff; color: #4f46e5; border: 1px solid #e0e7ff;
            padding: 10px; border-radius: 10px; font-size: 18px; cursor: pointer;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 0 15px 120px 15px; }

        .challenge-box {
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center;
        }
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .mode-btn { 
            padding: 14px; border-radius: 12px; border: 1px solid #eee; font-size: 14px; cursor: pointer;
            background: #f9f9f9; font-weight: 600; color: #666; transition: all 0.2s;
        }
        .mode-btn.active { background: #6366f1; color: white; border-color: #6366f1; }

        .start-btn {
            width: 100%; margin-top: 15px; padding: 16px; border-radius: 15px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        /* åˆ—è¡¨è¡Œæ ·å¼ - å¸ƒå±€ä¼˜åŒ– */
        .word-row {
            display: flex; padding: 16px; background: white; border-radius: 12px;
            margin-bottom: 10px; align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œé€‚åº”é•¿æ–‡æœ¬ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: background-color 0.2s;
            position: relative;
        }
        /* é•¿æŒ‰æ’åºæ—¶çš„æ¿€æ´»çŠ¶æ€ */
        .word-row.sorting {
            background-color: var(--sort-bg) !important;
            border: 2px solid #ffeeba;
            transform: scale(1.02);
            z-index: 10;
        }

        /* å•è¯åˆ— - å…è®¸æ¢è¡Œï¼Œå æ¯”æ›´å¤§ */
        .col-hr { 
            flex: 7; /* å 70% */
            font-weight: 600; display: flex; align-items: flex-start; 
            word-break: break-word; /* å…è®¸é•¿å•è¯æ¢è¡Œ */
            overflow-wrap: break-word;
            margin-right: 8px;
            line-height: 1.4;
        }
        /* ä¸­æ–‡åˆ— - å³å¯¹é½ï¼Œå…è®¸æ¢è¡Œ */
        .col-cn { 
            flex: 3; /* å 30% */
            text-align: right; color: #666; 
            word-break: break-all;
            line-height: 1.4;
            padding-top: 2px;
        }
        
        /* ç¼–è¾‘çŠ¶æ€ */
        .editing { 
            background: #fff !important; 
            border-bottom: 2px solid #6366f1 !important; 
            outline: none; 
            user-select: text !important; -webkit-user-select: text !important;
        }
        
        .icon-audio { width: 20px; height: 20px; margin-right: 8px; fill: var(--primary); flex-shrink: 0; margin-top: 2px; cursor: pointer;}

        /* æ“ä½œæŒ‰é’®åŒºåŸŸ */
        .action-area {
            width: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-left: 5px;
        }
        .del-word-btn { color: #ddd; cursor: pointer; font-size: 18px; padding: 5px;}
        .del-word-btn:hover { color: var(--danger); }
        
        /* æ’åºæŒ‰é’® (é»˜è®¤éšè—) */
        .sort-btns { display: none; flex-direction: column; gap: 8px; }
        .sort-btn { font-size: 14px; background: #eee; border-radius: 4px; padding: 4px; cursor: pointer; text-align: center; }

        #challengeOverlay {
            display: none; position: fixed; inset: 0; background: white; z-index: 2000;
            flex-direction: column; padding-top: env(safe-area-inset-top);
        }
        .challenge-header { display:flex; justify-content: space-between; padding:20px; border-bottom:1px solid #eee; align-items: center;}
        .challenge-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;}

        .quiz-option { width: 100%; max-width: 400px; padding: 18px; margin-bottom: 12px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; cursor: pointer; font-size: 16px;}
        .quiz-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; }
        .match-item { 
            padding: 22px 10px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; 
            background: #fff; font-size: 15px; transition: all 0.2s; cursor: pointer; font-weight: 500;
            display: flex; align-items: center; justify-content: center; word-break: break-word;
        }
        .match-item.selected { border-color: #6366f1; background: #f5f3ff; }
        .match-item.match-correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; transform: scale(0.95); opacity: 0.5; }
        .match-item.match-wrong { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .match-item.hidden { visibility: hidden; pointer-events: none; }

        .panel { display: none; background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        
        .footer-del-btn {
            width: 100%; padding: 15px; background: #fff; border: 2px solid #ffebeb; color: var(--danger);
            border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 30px;
        }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>ğŸ‡­ğŸ‡· å…‹è¯­åŠ©æ‰‹ V32</h1>
        <button class="nav-btn" style="padding: 6px 12px; font-size: 12px; background:none; border:1px solid #eee" onclick="togglePanel('syncPanel')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div class="nav-controls">
        <button class="nav-btn" onclick="changeUnit(1)">â†</button>
        <select id="unitSelect" onchange="jumpToUnit()"></select>
        <button class="nav-btn" onclick="changeUnit(-1)">â†’</button>
        <button class="notebook-btn" onclick="goToNotebook()">ğŸ“•</button>
    </div>
</div>

<div class="container">
    <div class="challenge-box">
        <div class="mode-selector">
            <div class="mode-btn active" id="mode-quiz" onclick="setMode('quiz')">é€‰æ‹©æ¨¡å¼</div>
            <div class="mode-btn" id="mode-match" onclick="setMode('match')">è¿è¿çœ‹æ¨¡å¼</div>
        </div>
        <button class="start-btn" onclick="startChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div id="syncPanel" class="panel">
        <button class="mode-btn" style="width:100%; margin-bottom:15px; background:#fff3cd; color:#856404; border:1px solid #ffeeba" onclick="removeDuplicates()">ğŸ§¹ ä¸€é”®æ¸…ç†æ‰€æœ‰é‡å¤å•è¯</button>
        <button class="mode-btn" style="width:100%; margin-bottom:8px;" onclick="document.getElementById('fileInput').click()">â¬†ï¸ å¯¼å…¥æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">
        <button class="mode-btn" style="width:100%; margin-bottom:15px;" onclick="downloadAll()">â¬‡ï¸ ä¸‹è½½å¤‡ä»½</button>
        <textarea id="codeText" class="input-box" style="height:60px;" placeholder="ä»£ç åŒºåŸŸ..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <button class="mode-btn" onclick="copyFullCode()">å¤åˆ¶å…¨ç </button>
            <button class="mode-btn" onclick="importFromCode()">ä»£ç å¯¼å…¥</button>
        </div>
    </div>

    <div style="text-align:center; color:#6366f1; margin: 20px 0; cursor:pointer; font-weight:bold" onclick="togglePanel('importPanel')">ï¼‹ å½•å…¥æ–°è¯</div>
    <div id="importPanel" class="panel">
        <input type="text" id="unitNameInput" class="input-box" placeholder="å•å…ƒåç§° (ä¸å¡«åˆ™æ·»åŠ åˆ°å½“å‰å•å…ƒ)">
        <select id="insertAfterSelect" class="input-box" style="text-align: left; text-align-last: left;"></select>
        <textarea id="importText" class="input-box" style="height:100px" placeholder="dva 2 (åŒåå•è¯ä¼šè‡ªåŠ¨è¦†ç›–æ›´æ–°)"></textarea>
        <button class="start-btn" style="margin-top:0" onclick="importWords()">ç¡®è®¤ä¿å­˜</button>
    </div>

    <div id="wordListContainer"></div>
    
    <button class="footer-del-btn" onclick="deleteCurrentUnit()">ğŸ—‘ï¸ åˆ é™¤å½“å‰å•å…ƒ</button>
</div>

<div id="challengeOverlay">
    <div class="challenge-header">
        <button onclick="exitChallenge()" style="border:none; background:none; font-size:24px; color:#999">âœ•</button>
        <div id="challengeProgress" style="font-weight:bold; color:#6366f1">0 / 0</div>
        <label style="font-size:13px; color:#666"><input type="checkbox" id="autoVoice" checked> è‡ªåŠ¨å‘éŸ³</label>
    </div>
    <div id="challengeMain" class="challenge-body"></div>
</div>

<audio id="audioPlayer" playsinline></audio>

<script>
    const audioIconSvg = `<svg class="icon-audio" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;

    let appData = JSON.parse(localStorage.getItem('cro_v32')) || JSON.parse(localStorage.getItem('cro_v31')) || [];
    let notebook = JSON.parse(localStorage.getItem('cro_notebook')) || [];
    let currentUnitIdx = appData.length > 0 ? 0 : -1;
    let currentMode = 'quiz';
    let challengeList = [];
    let pressTimer; // é•¿æŒ‰è®¡æ—¶å™¨
    let activeSortRow = null; // å½“å‰æ­£åœ¨æ’åºçš„è¡Œ

    const audioPlayer = document.getElementById('audioPlayer');

    function render() {
        const list = document.getElementById('wordListContainer');
        const select = document.getElementById('unitSelect');
        const insertSelect = document.getElementById('insertAfterSelect');
        const nameInput = document.getElementById('unitNameInput');
        
        list.innerHTML = ''; select.innerHTML = '';
        insertSelect.innerHTML = '<option value="-1">ç½®é¡¶æ·»åŠ </option>';

        if (appData.length === 0) {
            nameInput.placeholder = "å•å…ƒåç§°";
            return;
        }
        
        appData.forEach((u, i) => {
            select.add(new Option(u.name, i));
            insertSelect.add(new Option(`åœ¨ ${u.name} å`, i));
            if(i === currentUnitIdx) select.selectedIndex = i;
        });
        
        // ä¿®å¤ï¼šplaceholder æç¤ºå½“å‰å•å…ƒ
        if(currentUnitIdx !== -1) {
            nameInput.placeholder = `ç•™ç©ºåˆ™æ·»åŠ åˆ°: ${appData[currentUnitIdx].name}`;
        }

        const unit = appData[currentUnitIdx];
        if(!unit) return;
        unit.words.forEach((w, i) => {
            const row = document.createElement('div');
            row.className = 'word-row';
            
            // ç»‘å®šé•¿æŒ‰äº‹ä»¶
            row.addEventListener('touchstart', (e) => startPress(e, row, i));
            row.addEventListener('touchend', cancelPress);
            row.addEventListener('touchmove', cancelPress);
            row.addEventListener('mousedown', (e) => startPress(e, row, i));
            row.addEventListener('mouseup', cancelPress);
            row.addEventListener('mouseleave', cancelPress);

            // å†…å®¹åŒºåŸŸ
            row.innerHTML = `
                <div class="col-hr">
                    <span onclick="play('${w.hr.replace(/'/g, "\\'")}')">${audioIconSvg}</span>
                    <span ondblclick="enableEdit(this, ${i}, 'hr')">${w.hr}</span>
                </div>
                <div class="col-cn" ondblclick="enableEdit(this, ${i}, 'cn')">${w.cn}</div>
                <div class="action-area">
                    <div class="del-word-btn" onclick="delWord(${i})">âœ•</div>
                    <div class="sort-btns">
                        <div class="sort-btn" onclick="moveWord(${i}, -1)">â¬†ï¸</div>
                        <div class="sort-btn" onclick="moveWord(${i}, 1)">â¬‡ï¸</div>
                    </div>
                </div>
            `;
            list.appendChild(row);
        });
    }

    // --- åŒå‡»ç¼–è¾‘åŠŸèƒ½ ---
    function enableEdit(el, idx, field) {
        el.contentEditable = true;
        el.focus();
        el.classList.add('editing');
        
        // å¤±å»ç„¦ç‚¹æˆ–å›è½¦æ—¶ä¿å­˜
        const save = () => {
            el.contentEditable = false;
            el.classList.remove('editing');
            updateWord(idx, field, el);
        };
        
        el.onblur = save;
        el.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); el.blur(); } };
    }

    // --- é•¿æŒ‰æ’åºåŠŸèƒ½ ---
    function startPress(e, row, index) {
        // å¦‚æœç‚¹çš„ä¸æ˜¯æ–‡å­—åŒºåŸŸï¼ˆæ¯”å¦‚ç‚¹äº†åˆ é™¤æŒ‰é’®ï¼‰ï¼Œä¸è§¦å‘æ’åº
        if(e.target.classList.contains('del-word-btn') || e.target.classList.contains('sort-btn')) return;
        
        pressTimer = setTimeout(() => {
            activateSortMode(row);
        }, 1000); // 1ç§’é•¿æŒ‰
    }

    function cancelPress() {
        clearTimeout(pressTimer);
    }

    function activateSortMode(row) {
        // å…³é—­å…¶ä»–è¡Œçš„æ’åº
        if(activeSortRow) deactivateSortMode();
        
        activeSortRow = row;
        row.classList.add('sorting');
        row.querySelector('.del-word-btn').style.display = 'none';
        row.querySelector('.sort-btns').style.display = 'flex';
        
        // éœ‡åŠ¨åé¦ˆ (Androidæ”¯æŒ)
        if(navigator.vibrate) navigator.vibrate(50);
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å–æ¶ˆæ’åº
        document.addEventListener('click', outsideClickListener);
    }

    function deactivateSortMode() {
        if(!activeSortRow) return;
        activeSortRow.classList.remove('sorting');
        activeSortRow.querySelector('.del-word-btn').style.display = 'block';
        activeSortRow.querySelector('.sort-btns').style.display = 'none';
        activeSortRow = null;
        document.removeEventListener('click', outsideClickListener);
    }

    function outsideClickListener(e) {
        if(!activeSortRow) return;
        if(!activeSortRow.contains(e.target)) {
            deactivateSortMode();
        }
    }

    function moveWord(index, direction) {
        const words = appData[currentUnitIdx].words;
        const newIndex = index + direction;
        
        if(newIndex >= 0 && newIndex < words.length) {
            // äº¤æ¢ä½ç½®
            [words[index], words[newIndex]] = [words[newIndex], words[index]];
            saveData();
            render();
            // æ¸²æŸ“åå¯èƒ½éœ€è¦é‡æ–°æ¿€æ´»è¯¥è¡Œçš„æ’åºçŠ¶æ€ï¼Œæˆ–è€…ç®€å•ç‚¹ç›´æ¥é€€å‡ºæ’åº
            // ä¸ºäº†ä½“éªŒæµç•…ï¼Œè¿™é‡Œç›´æ¥é€€å‡ºæ’åºï¼Œé‡æ–°é•¿æŒ‰å³å¯
        }
    }

    // --- åŸºç¡€æ•°æ®åŠŸèƒ½ ---
    function updateWord(idx, field, el) {
        const val = el.innerText.trim();
        appData[currentUnitIdx].words[idx][field] = val;
        if(appData[currentUnitIdx].name === "ğŸ“• é”™é¢˜æœ¬") {
            if(notebook[idx]) notebook[idx][field] = val;
            localStorage.setItem('cro_notebook', JSON.stringify(notebook));
        }
        saveData();
    }

    function changeUnit(dir) {
        let n = currentUnitIdx + dir;
        if(n >= 0 && n < appData.length) { currentUnitIdx = n; render(); }
    }

    function importWords() {
        let name = document.getElementById('unitNameInput').value.trim();
        const text = document.getElementById('importText').value.trim();
        const after = parseInt(document.getElementById('insertAfterSelect').value);
        if(!text) return;
        
        let targetUnitIndex = -1;
        // å…³é”®ä¿®å¤ï¼šå¦‚æœåå­—ä¸ºç©ºï¼Œä¸”æœ‰å½“å‰å•å…ƒï¼Œåˆ™ç›®æ ‡ä¸ºå½“å‰å•å…ƒ
        if (!name && currentUnitIdx !== -1) targetUnitIndex = currentUnitIdx;

        const newWords = text.split('\n').map(l => { 
            let i = l.search(/[\u4e00-\u9fa5|0-9|,|;|ï¼Œ|ï¼›]/); 
            return i!==-1 ? {hr:l.slice(0,i).trim(), cn:l.slice(i).replace(/^[,;ï¼Œï¼›\s]+/,"").trim()} : {hr:l.trim(), cn:""}; 
        }).filter(w => w.hr);

        if (targetUnitIndex !== -1) {
            const unit = appData[targetUnitIndex];
            newWords.forEach(nw => {
                const existIdx = unit.words.findIndex(old => old.hr.toLowerCase() === nw.hr.toLowerCase());
                if (existIdx !== -1) unit.words[existIdx].cn = nw.cn;
                else unit.words.push(nw);
            });
            alert(`å·²æ›´æ–°/æ·»åŠ åˆ°æ—§å•å…ƒ: "${unit.name}"`);
        } else {
            if(!name) name = "æ–°å•å…ƒ";
            const newUnit = {name, words: newWords};
            if(after === -1) appData.unshift(newUnit); else appData.splice(after+1, 0, newUnit);
            alert(`å·²åˆ›å»ºæ–°å•å…ƒ: "${name}"`);
        }
        saveData(); render(); togglePanel('importPanel');
        document.getElementById('importText').value = ''; 
    }

    function play(t) { 
        if(!t || t.trim() === '') return;
        audioPlayer.src=`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(t)}&tl=hr&client=gtx`;
        audioPlayer.play().catch(e => { console.log('Blocked', e); });
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-quiz').classList.toggle('active', mode === 'quiz');
        document.getElementById('mode-match').classList.toggle('active', mode === 'match');
    }

    function startChallenge() {
        const unit = appData[currentUnitIdx];
        if(!unit || unit.words.length === 0) return;
        play(' '); // è§£é”éŸ³é¢‘
        let base = [...unit.words];
        let extra = [...base].sort(() => Math.random() - 0.5).slice(0, Math.ceil(base.length * 0.25));
        challengeList = [...base, ...extra].sort(() => Math.random() - 0.5);
        document.getElementById('challengeOverlay').style.display = 'flex';
        showQuestion();
    }

    function showQuestion() {
        if(challengeList.length === 0) { alert("æ­å–œï¼å¤ä¹ å®Œæˆ"); return exitChallenge(); }
        const main = document.getElementById('challengeMain');
        main.innerHTML = '';
        document.getElementById('challengeProgress').innerText = `å‰©ä½™: ${challengeList.length}`;

        if(currentMode === 'quiz') {
            const current = challengeList[0];
            if(document.getElementById('autoVoice').checked) play(current.hr);
            main.innerHTML = `<div style="font-size:28px; margin-bottom:30px; font-weight:bold; color:#6366f1; text-align:center">${current.hr}</div>`;
            const options = [current];
            const all = appData[currentUnitIdx].words;
            while(options.length < Math.min(all.length, 4)) {
                const r = all[Math.floor(Math.random() * all.length)];
                if(!options.includes(r)) options.push(r);
            }
            options.sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option'; btn.innerText = opt.cn;
                btn.onclick = () => {
                    if(opt === current) { 
                        btn.classList.add('correct'); 
                        setTimeout(() => { challengeList.shift(); showQuestion(); }, 500); 
                    } else { 
                        btn.classList.add('wrong'); 
                        addToNotebook(current); 
                    }
                };
                main.appendChild(btn);
            });
        } else {
            const num = Math.min(challengeList.length, 4);
            const currentBatch = challengeList.slice(0, num);
            const items = [...currentBatch.map(s => ({t: s.hr, id: s.hr, type:'hr'})), ...currentBatch.map(s => ({t: s.cn, id: s.hr, type:'cn'}))].sort(() => Math.random() - 0.5);
            main.innerHTML = `<div class="match-grid"></div>`;
            const grid = main.querySelector('.match-grid');
            let first = null; let matchedCount = 0;

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'match-item'; div.innerText = item.t;
                div.onclick = () => {
                    if(div.classList.contains('hidden') || div.classList.contains('match-correct')) return;
                    if(item.type === 'hr') play(item.t);
                    div.classList.add('selected');

                    if(!first) { first = {div, item}; } 
                    else {
                        if(first.div === div) return; 
                        if(first.item.id === item.id) {
                            first.div.className = 'match-item match-correct';
                            div.className = 'match-item match-correct';
                            matchedCount++; 
                            const fDiv = first.div; const sDiv = div;
                            setTimeout(() => { 
                                fDiv.classList.add('hidden'); sDiv.classList.add('hidden'); 
                                if(matchedCount === num) { challengeList.splice(0, num); showQuestion(); }
                            }, 400);
                        } else {
                            div.className = 'match-item match-wrong'; first.div.className = 'match-item match-wrong';
                            addToNotebook(challengeList.find(c => c.hr === item.id || c.hr === first.item.id));
                            const fDiv = first.div; const sDiv = div;
                            setTimeout(() => { sDiv.className = 'match-item'; fDiv.className = 'match-item'; }, 500);
                        }
                        first = null;
                    }
                };
                grid.appendChild(div);
            });
        }
    }

    function addToNotebook(word) {
        if(!notebook.some(w => w.hr === word.hr)) {
            notebook.push(word); localStorage.setItem('cro_notebook', JSON.stringify(notebook));
        }
        if(currentMode === 'quiz') { challengeList.push(challengeList.shift()); showQuestion(); }
    }
    
    function removeDuplicates() {
        if(!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰é‡å¤å•è¯å—ï¼Ÿ')) return;
        let c = 0; appData.forEach(u => {
            const m = new Map(), cl = []; u.words.forEach(w => { const k=w.hr.toLowerCase().trim(); if(!m.has(k)){m.set(k,1);cl.push(w)}else c++ }); u.words=cl;
        }); saveData(); render(); alert(`æ¸…ç†äº† ${c} ä¸ªé‡å¤`);
    }

    function saveData() { localStorage.setItem('cro_v32', JSON.stringify(appData)); }
    function jumpToUnit() { currentUnitIdx = document.getElementById('unitSelect').selectedIndex; render(); }
    function exitChallenge() { document.getElementById('challengeOverlay').style.display='none'; }
    function delWord(i) { if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { 
        if(appData[currentUnitIdx].name==="ğŸ“• é”™é¢˜æœ¬") { notebook.splice(i,1); localStorage.setItem('cro_notebook',JSON.stringify(notebook)); }
        appData[currentUnitIdx].words.splice(i,1); saveData(); render(); 
    }}
    function deleteCurrentUnit() { if(confirm('âš ï¸ åˆ å•å…ƒï¼Ÿ')) { 
        if(appData[currentUnitIdx].name==="ğŸ“• é”™é¢˜æœ¬") { notebook=[]; localStorage.setItem('cro_notebook',JSON.stringify(notebook)); }
        appData.splice(currentUnitIdx,1); currentUnitIdx=0; saveData(); render(); 
    }}
    function togglePanel(id) { const p=document.getElementById(id); p.style.display=(p.style.display==='block'?'none':'block'); }
    function goToNotebook() {
        if(notebook.length===0) return alert('ç©º');
        const name="ğŸ“• é”™é¢˜æœ¬"; const idx=appData.findIndex(u=>u.name===name);
        if(idx>-1) appData[idx].words=notebook; else appData.unshift({name, words:notebook});
        currentUnitIdx=0; render();
    }
    function copyFullCode() { const a=document.getElementById('codeText'); a.value=JSON.stringify(appData); a.select(); document.execCommand('copy'); }
    function downloadAll() { const b=new Blob([JSON.stringify(appData,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`cro_v32.json`; a.click(); }
    function handleFileImport(i) { const r=new FileReader(); r.onload=(e)=>{ appData=[...JSON.parse(e.target.result),...appData]; saveData(); render(); }; r.readAsText(i.files[0]); }
    function importFromCode() { try { appData=[...JSON.parse(document.getElementById('codeText').value),...appData]; saveData(); render(); alert('æˆåŠŸ'); } catch(e){alert('é”™è¯¯');} }
    
    render();
</script>
</body>
</html>
