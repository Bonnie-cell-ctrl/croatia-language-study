<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…‹è¯­åŠ©æ‰‹ V33 (è‡ªç”±æ‹–æ‹½ç‰ˆ)</title>
    <style>
        :root {
            --primary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f7f9fc;
            --drag-bg: #eef2ff;
        }
        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg); margin: 0; padding-top: 110px;
            color: #333; 
            /* é˜²æ­¢æ‹–æ‹½æ—¶è§¦å‘ç³»ç»Ÿæ»šåŠ¨ */
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }

        .sticky-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000; padding: 15px; box-sizing: border-box;
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .header-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }
        
        .nav-controls { display: flex; gap: 8px; max-width: 800px; margin: 0 auto; align-items: center; }
        .nav-btn { 
            background: #f0f2f5; color: #555; border: none; 
            padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;
        }
        select { 
            flex: 1; padding: 10px; border: 1px solid #e1e4e8; border-radius: 10px; 
            font-size: 15px; text-align: center; text-align-last: center; background: white;
        }
        .notebook-btn {
            width: 25%; background: #eef2ff; color: #4f46e5; border: 1px solid #e0e7ff;
            padding: 10px; border-radius: 10px; font-size: 18px; cursor: pointer;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 0 15px 120px 15px; }

        .challenge-box {
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center;
        }
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .mode-btn { 
            padding: 14px; border-radius: 12px; border: 1px solid #eee; font-size: 14px; cursor: pointer;
            background: #f9f9f9; font-weight: 600; color: #666; transition: all 0.2s;
        }
        .mode-btn.active { background: #6366f1; color: white; border-color: #6366f1; }
        .start-btn {
            width: 100%; margin-top: 15px; padding: 16px; border-radius: 15px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        /* --- åˆ—è¡¨å¸ƒå±€å‡çº§ --- */
        .word-row {
            display: flex; padding: 16px; background: white; border-radius: 12px;
            margin-bottom: 10px; align-items: flex-start;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .word-row.dragging {
            opacity: 0.9;
            background: var(--drag-bg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 100;
            transform: scale(1.02);
        }

        /* å…³é”® CSSï¼šå…è®¸æ¢è¡Œå’Œå›è½¦æ˜¾ç¤º */
        .col-hr, .col-cn { 
            padding: 4px; border-radius: 4px; 
            white-space: pre-wrap; /* å…è®¸å›è½¦æ¢è¡Œæ˜¾ç¤º */
            word-break: break-word; /* é˜²æ­¢é•¿å•è¯æº¢å‡º */
            line-height: 1.5;
        }
        .col-hr { flex: 6; font-weight: 600; margin-right: 8px; }
        .col-cn { flex: 3; text-align: right; color: #666; }

        .editing { 
            background: #fff !important; 
            border: 1px solid #6366f1 !important; 
            outline: none; 
            min-height: 24px;
        }

        .icon-audio { width: 22px; height: 22px; margin-right: 8px; fill: var(--primary); flex-shrink: 0; margin-top: 2px; cursor: pointer;}

        /* æ“ä½œåŒºï¼šåˆ é™¤ + æ‹–æ‹½æ‰‹æŸ„ */
        .action-area {
            width: 40px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; margin-left: 5px; gap: 15px;
        }
        .del-word-btn { color: #ddd; cursor: pointer; font-size: 18px; padding: 5px; }
        .del-word-btn:hover { color: var(--danger); }
        
        /* æ‹–æ‹½æ‰‹æŸ„å›¾æ ‡ */
        .drag-handle {
            color: #ccc; cursor: grab; font-size: 20px; padding: 5px 10px;
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨å¤„ç†è§¦æ‘¸ï¼Œäº¤ç»™JSå¤„ç† */
        }
        .drag-handle:active { color: var(--primary); cursor: grabbing; }

        /* é¢æ¿æ ·å¼ */
        .panel { display: none; background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .footer-del-btn { width: 100%; padding: 15px; background: #fff; border: 2px solid #ffebeb; color: var(--danger); border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 30px; }
        
        /* æŒ‘æˆ˜å±‚ */
        #challengeOverlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; padding-top: env(safe-area-inset-top); }
        .challenge-header { display:flex; justify-content: space-between; padding:20px; border-bottom:1px solid #eee; align-items: center;}
        .challenge-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;}
        .quiz-option { width: 100%; max-width: 400px; padding: 18px; margin-bottom: 12px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; cursor: pointer; font-size: 16px;}
        .quiz-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; }
        .match-item { padding: 22px 10px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; background: #fff; font-size: 15px; transition: all 0.2s; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; word-break: break-word; }
        .match-item.selected { border-color: #6366f1; background: #f5f3ff; }
        .match-item.match-correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; transform: scale(0.95); opacity: 0.5; }
        .match-item.match-wrong { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .match-item.hidden { visibility: hidden; pointer-events: none; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>ğŸ‡­ğŸ‡· å…‹è¯­åŠ©æ‰‹ V33</h1>
        <button class="nav-btn" style="padding: 6px 12px; font-size: 12px; background:none; border:1px solid #eee" onclick="togglePanel('syncPanel')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div class="nav-controls">
        <button class="nav-btn" onclick="changeUnit(1)">â†</button>
        <select id="unitSelect" onchange="jumpToUnit()"></select>
        <button class="nav-btn" onclick="changeUnit(-1)">â†’</button>
        <button class="notebook-btn" onclick="goToNotebook()">ğŸ“•</button>
    </div>
</div>

<div class="container">
    <div class="challenge-box">
        <div class="mode-selector">
            <div class="mode-btn active" id="mode-quiz" onclick="setMode('quiz')">é€‰æ‹©æ¨¡å¼</div>
            <div class="mode-btn" id="mode-match" onclick="setMode('match')">è¿è¿çœ‹æ¨¡å¼</div>
        </div>
        <button class="start-btn" onclick="startChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div id="syncPanel" class="panel">
        <button class="mode-btn" style="width:100%; margin-bottom:15px; background:#fff3cd; color:#856404; border:1px solid #ffeeba" onclick="removeDuplicates()">ğŸ§¹ ä¸€é”®æ¸…ç†æ‰€æœ‰é‡å¤å•è¯</button>
        <button class="mode-btn" style="width:100%; margin-bottom:8px;" onclick="document.getElementById('fileInput').click()">â¬†ï¸ å¯¼å…¥æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">
        <button class="mode-btn" style="width:100%; margin-bottom:15px;" onclick="downloadAll()">â¬‡ï¸ ä¸‹è½½å¤‡ä»½</button>
        <textarea id="codeText" class="input-box" style="height:60px;" placeholder="ä»£ç åŒºåŸŸ..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <button class="mode-btn" onclick="copyFullCode()">å¤åˆ¶å…¨ç </button>
            <button class="mode-btn" onclick="importFromCode()">ä»£ç å¯¼å…¥</button>
        </div>
    </div>

    <div style="text-align:center; color:#6366f1; margin: 20px 0; cursor:pointer; font-weight:bold" onclick="togglePanel('importPanel')">ï¼‹ å½•å…¥æ–°è¯</div>
    <div id="importPanel" class="panel">
        <input type="text" id="unitNameInput" class="input-box" placeholder="å•å…ƒåç§° (ä¸å¡«åˆ™æ·»åŠ åˆ°å½“å‰å•å…ƒ)">
        <select id="insertAfterSelect" class="input-box" style="text-align: left; text-align-last: left;"></select>
        <textarea id="importText" class="input-box" style="height:100px" placeholder="dva 2 (åŒåå•è¯ä¼šè‡ªåŠ¨è¦†ç›–æ›´æ–°)"></textarea>
        <button class="start-btn" style="margin-top:0" onclick="importWords()">ç¡®è®¤ä¿å­˜</button>
    </div>

    <div id="wordListContainer"></div>
    <button class="footer-del-btn" onclick="deleteCurrentUnit()">ğŸ—‘ï¸ åˆ é™¤å½“å‰å•å…ƒ</button>
</div>

<div id="challengeOverlay">
    <div class="challenge-header">
        <button onclick="exitChallenge()" style="border:none; background:none; font-size:24px; color:#999">âœ•</button>
        <div id="challengeProgress" style="font-weight:bold; color:#6366f1">0 / 0</div>
        <label style="font-size:13px; color:#666"><input type="checkbox" id="autoVoice" checked> è‡ªåŠ¨å‘éŸ³</label>
    </div>
    <div id="challengeMain" class="challenge-body"></div>
</div>

<audio id="audioPlayer" playsinline></audio>

<script>
    const audioIconSvg = `<svg class="icon-audio" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;

    let appData = JSON.parse(localStorage.getItem('cro_v33')) || JSON.parse(localStorage.getItem('cro_v32')) || [];
    let notebook = JSON.parse(localStorage.getItem('cro_notebook')) || [];
    let currentUnitIdx = appData.length > 0 ? 0 : -1;
    let currentMode = 'quiz';
    let challengeList = [];
    const audioPlayer = document.getElementById('audioPlayer');

    // æ‹–æ‹½ç›¸å…³å˜é‡
    let dragEl = null;

    function render() {
        const list = document.getElementById('wordListContainer');
        const select = document.getElementById('unitSelect');
        const insertSelect = document.getElementById('insertAfterSelect');
        const nameInput = document.getElementById('unitNameInput');
        
        list.innerHTML = ''; select.innerHTML = '';
        insertSelect.innerHTML = '<option value="-1">ç½®é¡¶æ·»åŠ </option>';

        if (appData.length === 0) { nameInput.placeholder = "å•å…ƒåç§°"; return; }
        
        appData.forEach((u, i) => {
            select.add(new Option(u.name, i));
            insertSelect.add(new Option(`åœ¨ ${u.name} å`, i));
            if(i === currentUnitIdx) select.selectedIndex = i;
        });
        
        if(currentUnitIdx !== -1) nameInput.placeholder = `ç•™ç©ºåˆ™æ·»åŠ åˆ°: ${appData[currentUnitIdx].name}`;

        const unit = appData[currentUnitIdx];
        if(!unit) return;
        unit.words.forEach((w, i) => {
            const row = document.createElement('div');
            row.className = 'word-row';
            row.dataset.index = i; // æ ‡è®°ç´¢å¼•ï¼Œç”¨äºæ‹–æ‹½åé‡å»ºæ•°æ®
            
            row.innerHTML = `
                <div style="display:flex; flex-direction:column; flex:1">
                    <div style="display:flex; align-items:flex-start">
                        <span onclick="play('${w.hr.replace(/'/g, "\\'")}')">${audioIconSvg}</span>
                        <div class="col-hr" ondblclick="enableEdit(this, ${i}, 'hr')">${w.hr}</div>
                    </div>
                </div>
                <div class="col-cn" ondblclick="enableEdit(this, ${i}, 'cn')">${w.cn}</div>
                <div class="action-area">
                    <div class="del-word-btn" onclick="delWord(${i})">âœ•</div>
                    <div class="drag-handle">â‰¡</div>
                </div>
            `;

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶åˆ° handle ä¸Š
            const handle = row.querySelector('.drag-handle');
            handle.addEventListener('touchstart', handleTouchStart, {passive: false});
            handle.addEventListener('touchmove', handleTouchMove, {passive: false});
            handle.addEventListener('touchend', handleTouchEnd);
            handle.addEventListener('mousedown', handleMouseDown); // ç”µè„‘ç«¯é¼ æ ‡æ”¯æŒ
            
            list.appendChild(row);
        });
    }

    // --- æ‹–æ‹½é€»è¾‘ (æ‰‹æœº+ç”µè„‘é€šç”¨) ---
    function handleTouchStart(e) {
        dragEl = this.closest('.word-row');
        dragEl.classList.add('dragging');
    }

    function handleTouchMove(e) {
        if (!dragEl) return;
        e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
        
        // è·å–æ‰‹æŒ‡ä½ç½®çš„å…ƒç´ 
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetRow = target ? target.closest('.word-row') : null;

        // å¦‚æœæ‰‹æŒ‡ç§»åˆ°äº†å¦ä¸€è¡Œï¼Œäº¤æ¢ä½ç½®
        if (targetRow && targetRow !== dragEl) {
            const list = document.getElementById('wordListContainer');
            // è·å–æ‰€æœ‰è¡Œï¼Œåˆ¤æ–­å½“å‰ä½ç½®
            const children = Array.from(list.children);
            const dragIndex = children.indexOf(dragEl);
            const targetIndex = children.indexOf(targetRow);
            
            if (dragIndex < targetIndex) {
                list.insertBefore(dragEl, targetRow.nextSibling);
            } else {
                list.insertBefore(dragEl, targetRow);
            }
        }
    }

    function handleTouchEnd(e) {
        if (!dragEl) return;
        dragEl.classList.remove('dragging');
        dragEl = null;
        rebuildDataFromDOM(); // æ‹–æ‹½ç»“æŸåï¼Œæ ¹æ®DOMé¡ºåºé‡ç»„æ•°æ®
    }

    // ç”µè„‘ç«¯é¼ æ ‡æ‹–æ‹½æ¨¡æ‹Ÿ
    function handleMouseDown(e) {
        dragEl = this.closest('.word-row');
        dragEl.classList.add('dragging');
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
    function handleMouseMove(e) {
        if(!dragEl) return;
        e.preventDefault();
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const targetRow = target ? target.closest('.word-row') : null;
        if (targetRow && targetRow !== dragEl) {
            const list = document.getElementById('wordListContainer');
            const children = Array.from(list.children);
            if (children.indexOf(dragEl) < children.indexOf(targetRow)) {
                list.insertBefore(dragEl, targetRow.nextSibling);
            } else {
                list.insertBefore(dragEl, targetRow);
            }
        }
    }
    function handleMouseUp() {
        if(dragEl) dragEl.classList.remove('dragging');
        dragEl = null;
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        rebuildDataFromDOM();
    }

    // æ ¹æ®é¡µé¢ä¸Šçš„é¡ºåºé‡ç»„ appData
    function rebuildDataFromDOM() {
        const rows = document.querySelectorAll('.word-row');
        const newWords = [];
        rows.forEach(row => {
            const hr = row.querySelector('.col-hr').innerText;
            const cn = row.querySelector('.col-cn').innerText;
            newWords.push({hr, cn});
        });
        appData[currentUnitIdx].words = newWords;
        saveData();
        // è¿™é‡Œä¸è°ƒç”¨renderï¼Œå› ä¸ºDOM
