<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…‹è¯­åŠ©æ‰‹ V52 (åå°ä¿æ´»ç‰ˆ)</title>
    <style>
        :root {
            --primary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f7f9fc;
            --drag-bg: #fff9c4;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); margin: 0; padding-top: 110px;
            color: #333; 
            overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 60px;
        }

        .sticky-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000; padding: 15px; box-sizing: border-box;
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .header-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }
        
        .nav-controls { display: flex; gap: 8px; max-width: 800px; margin: 0 auto; align-items: center; }
        .nav-btn { 
            background: #f0f2f5; color: #555; border: none; 
            padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;
        }
        select { 
            flex: 1; padding: 10px; border: 1px solid #e1e4e8; border-radius: 10px; 
            font-size: 15px; text-align: center; text-align-last: center; background: white;
            color: #333; font-weight: 600; 
        }
        .listen-btn {
            width: 15%; background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd;
            padding: 10px; border-radius: 10px; font-size: 18px; cursor: pointer;
        }
        .notebook-btn {
            width: 15%; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;
            padding: 10px; border-radius: 10px; font-size: 18px; cursor: pointer;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 0 15px 120px 15px; }

        .challenge-box {
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center;
        }
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 5px; }
        .mode-btn { 
            padding: 10px 4px; border-radius: 10px; border: 1px solid #eee; font-size: 13px; cursor: pointer;
            background: #f9f9f9; font-weight: 600; color: #666; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .mode-btn.active { background: #6366f1; color: white; border-color: #6366f1; }
        .start-btn {
            width: 100%; margin-top: 15px; padding: 16px; border-radius: 15px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        .word-row {
            display: flex; padding: 16px; background: white; border-radius: 12px;
            margin-bottom: 10px; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            transition: transform 0.2s, background-color 0.2s;
        }
        .word-row.dragging {
            background: var(--drag-bg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            z-index: 100; transform: scale(1.03); border: 1px solid #ffe082;
        }
        .word-row.playing-now {
            border: 2px solid #0ea5e9; background-color: #f0f9ff;
        }

        .left-part { flex: 1; display: flex; align-items: flex-start; min-width: 0; margin-right: 10px; }
        .col-hr { 
            font-weight: 600; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; 
            line-height: 1.4; user-select: text; -webkit-user-select: text;
        }
        .col-cn { 
            flex: 0 0 auto; max-width: 35%; text-align: right; color: #666; 
            white-space: pre-wrap; word-wrap: break-word; font-size: 14px;
            user-select: text; -webkit-user-select: text;
        }
        .editing { background: #fff !important; border-bottom: 2px solid #6366f1 !important; outline: none; min-height: 24px; }
        .icon-audio { width: 22px; height: 22px; margin-right: 10px; fill: var(--primary); flex-shrink: 0; margin-top: 2px; cursor: pointer;}
        
        .action-area { flex: 0 0 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-left: 8px; gap: 15px; }
        .del-word-btn { color: #ddd; cursor: pointer; font-size: 16px; padding: 5px; }
        .del-word-btn:hover { color: var(--danger); }
        .drag-handle { color: #ccc; cursor: grab; font-size: 24px; padding: 10px 15px; touch-action: none; user-select: none; }
        .drag-handle.active { color: #f57f17; transform: scale(1.2); cursor: grabbing; }

        .panel { display: none; background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .footer-del-btn { width: 100%; padding: 15px; background: #fff; border: 2px solid #ffebeb; color: var(--danger); border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 30px; }
        
        #challengeOverlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; padding-top: env(safe-area-inset-top); }
        .challenge-header { display:flex; justify-content: space-between; padding:20px; border-bottom:1px solid #eee; align-items: center;}
        .challenge-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;}
        
        .quiz-option { width: 100%; max-width: 400px; padding: 18px; margin-bottom: 12px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; cursor: pointer; font-size: 16px;}
        .quiz-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; }
        .match-item { padding: 22px 10px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; background: #fff; font-size: 15px; transition: all 0.2s; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; word-break: break-word; }
        .match-item.selected { border-color: #6366f1; background: #f5f3ff; }
        .match-item.match-correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; transform: scale(0.95); opacity: 0.5; }
        .match-item.match-wrong { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .match-item.hidden { visibility: hidden; pointer-events: none; }
        .spelling-container { width: 100%; max-width: 400px; text-align: center; }
        .spelling-input { width: 100%; padding: 15px; font-size: 20px; text-align: center; border: 2px solid #6366f1; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .spelling-input.error { border-color: var(--danger); background: #fff5f5; }
        .spelling-input.success { border-color: var(--success); background: #f0fff4; }
        .special-chars { display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .char-btn { background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; padding: 8px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 18px; user-select: none; }
        .char-btn:active { background: #4f46e5; color: white; }
        .spelling-feedback { min-height: 24px; margin-bottom: 15px; font-weight: bold; }

        /* æ²‰æµ¸æ¨¡å¼ */
        #immersiveOverlay {
            display: none; position: fixed; inset: 0; background: #000; z-index: 3000;
            color: #fff; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 40px;
        }
        .immersive-word { font-size: 32px; font-weight: bold; margin-bottom: 20px; color: #fff; }
        .immersive-cn { font-size: 20px; color: #888; margin-bottom: 60px; }
        .immersive-ctrl { 
            width: 80px; height: 80px; border-radius: 50%; background: #333; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
            cursor: pointer; border: 2px solid #555;
        }
        .immersive-tip { position: absolute; bottom: 40px; font-size: 12px; color: #666; }
        #voice-picker-container { margin-top: 15px; background: #f0f9ff; padding: 10px; border-radius: 10px; }
        #voiceSelect { width: 100%; margin-top: 5px; border: 1px solid #bae6fd; font-weight: bold; color: #0284c7; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>ğŸ‡­ğŸ‡· å…‹è¯­åŠ©æ‰‹ V52 (åå°ä¿æ´»)</h1>
        <button class="nav-btn" style="padding: 6px 12px; font-size: 12px; background:none; border:1px solid #eee" onclick="togglePanel('syncPanel')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div class="nav-controls">
        <button class="nav-btn" onclick="changeUnit(1)">â†</button>
        <select id="unitSelect" onchange="jumpToUnit()"></select>
        <button class="nav-btn" onclick="changeUnit(-1)">â†’</button>
        <button class="listen-btn" onclick="startImmersiveMode()">ğŸ§</button>
        <button class="notebook-btn" onclick="goToNotebook()">ğŸ“•</button>
    </div>
</div>

<div class="container">
    <div class="challenge-box">
        <div class="mode-selector">
            <div class="mode-btn active" id="mode-quiz" onclick="setMode('quiz')">é€‰æ‹©</div>
            <div class="mode-btn" id="mode-match" onclick="setMode('match')">è¿è¿çœ‹</div>
            <div class="mode-btn" id="mode-spell" onclick="setMode('spell')">æ‹¼å†™</div>
            <div class="mode-btn" id="mode-mixed" onclick="setMode('mixed')">æ··åˆ</div>
        </div>
        <button class="start-btn" onclick="startChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div id="syncPanel" class="panel">
        <button class="mode-btn" style="width:100%; margin-bottom:15px; background:#fff3cd; color:#856404; border:1px solid #ffeeba" onclick="removeDuplicates()">ğŸ§¹ ä¸€é”®æ¸…ç†é‡å¤</button>
        <button class="mode-btn" style="width:100%; margin-bottom:8px;" onclick="document.getElementById('fileInput').click()">â¬†ï¸ å¯¼å…¥æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">
        <button class="mode-btn" style="width:100%; margin-bottom:15px;" onclick="downloadAll()">â¬‡ï¸ ä¸‹è½½å¤‡ä»½</button>
        <textarea id="codeText" class="input-box" style="height:60px;" placeholder="ä»£ç åŒºåŸŸ..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <button class="mode-btn" onclick="copyFullCode()">å¤åˆ¶å…¨ç </button>
            <button class="mode-btn" onclick="importFromCode()">ä»£ç å¯¼å…¥</button>
        </div>
        <div id="voice-picker-container">
            <label style="font-size:12px; color:#555;">ğŸ—£ï¸ é€‰æ‹©å…‹è¯­å‘éŸ³ (è¯·é€‰ Google Croatian):</label>
            <select id="voiceSelect" onchange="saveVoiceSelection()"></select>
        </div>
    </div>

    <div style="text-align:center; color:#6366f1; margin: 20px 0; cursor:pointer; font-weight:bold" onclick="togglePanel('importPanel')">ï¼‹ å½•å…¥æ–°è¯</div>
    <div id="importPanel" class="panel">
        <input type="text" id="unitNameInput" class="input-box" placeholder="å•å…ƒåç§° (ä¸å¡«åˆ™æ·»åŠ åˆ°å½“å‰å•å…ƒ)">
        <select id="insertAfterSelect" class="input-box" style="text-align: left; text-align-last: left;"></select>
        <textarea id="importText" class="input-box" style="height:100px" placeholder="dva 2"></textarea>
        <button class="start-btn" style="margin-top:0" onclick="importWords()">ç¡®è®¤ä¿å­˜</button>
    </div>

    <div id="wordListContainer"></div>
    <button class="footer-del-btn" onclick="deleteCurrentUnit()">ğŸ—‘ï¸ åˆ é™¤å½“å‰å•å…ƒ</button>
</div>

<div id="challengeOverlay">
    <div class="challenge-header">
        <button onclick="exitChallenge()" style="border:none; background:none; font-size:24px; color:#999">âœ•</button>
        <div id="challengeProgress" style="font-weight:bold; color:#6366f1">0 / 0</div>
        <label style="font-size:13px; color:#666"><input type="checkbox" id="autoVoice" checked> è‡ªåŠ¨å‘éŸ³</label>
    </div>
    <div id="challengeMain" class="challenge-body"></div>
</div>

<div id="immersiveOverlay">
    <div id="immHr" class="immersive-word">å‡†å¤‡æ’­æ”¾...</div>
    <div id="immCn" class="immersive-cn"></div>
    <div class="immersive-ctrl" onclick="stopImmersiveMode()">â¹</div>
    <div class="immersive-tip">ğŸµ åå°å¹¿æ’­æ¨¡å¼<br>æ”¯æŒé”å±/åå°æ’­æ”¾ï¼Œè¯·å‹¿æ¸…ç†åå°</div>
</div>

<audio id="silentDriver" playsinline></audio>

<script>
    const audioIconSvg = `<svg class="icon-audio" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
    
    // é™éŸ³MP3ï¼Œç”¨äºå……å½“"å¿ƒè·³"
    const SILENT_MP3 = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAASAAAAAAAASAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA';

    let appData = JSON.parse(localStorage.getItem('cro_v52')) || JSON.parse(localStorage.getItem('cro_v51')) || [];
    let notebook = JSON.parse(localStorage.getItem('cro_notebook')) || [];
    let savedUnitIdx = parseInt(localStorage.getItem('cro_last_unit_idx'));
    let currentUnitIdx = (!isNaN(savedUnitIdx) && savedUnitIdx >= 0 && savedUnitIdx < appData.length) ? savedUnitIdx : (appData.length > 0 ? 0 : -1);

    // --- ğŸ—£ï¸ TTS è¯­éŸ³å¼•æ“ç®¡ç†å™¨ ---
    let availableVoices = [];
    let selectedVoiceURI = localStorage.getItem('cro_selected_voice') || '';

    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = '<option value="">-- ç³»ç»Ÿé»˜è®¤ --</option>';
        let foundHr = false;
        availableVoices.forEach(voice => {
            const label = `${voice.name} (${voice.lang})`;
            if (voice.lang.includes('hr') || voice.name.includes('Croatian') || voice.name.includes('Hrvatski')) {
                const opt = new Option("ğŸŒŸ " + label, voice.voiceURI);
                select.add(opt);
                foundHr = true;
            }
        });
        if(!foundHr) {
            const opt = new Option("--- å…¨éƒ¨è¯­éŸ³ ---", ""); opt.disabled = true; select.add(opt);
            availableVoices.forEach(voice => { select.add(new Option(voice.name, voice.voiceURI)); });
        }
        if (selectedVoiceURI) select.value = selectedVoiceURI;
        if (!selectedVoiceURI && foundHr) {
            for (let i=0; i<select.options.length; i++) {
                if (select.options[i].text.includes('Google')) {
                    select.selectedIndex = i; saveVoiceSelection(); break;
                }
            }
        }
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 500);

    function saveVoiceSelection() {
        selectedVoiceURI = document.getElementById('voiceSelect').value;
        localStorage.setItem('cro_selected_voice', selectedVoiceURI);
        speakLocal('Dobar dan', 'hr');
    }

    function speakLocal(text, lang, onEndCallback) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if (lang === 'hr' && selectedVoiceURI) {
            const voice = availableVoices.find(v => v.voiceURI === selectedVoiceURI);
            if (voice) u.voice = voice;
        }
        if (lang === 'hr') u.lang = 'hr-HR'; else if (lang === 'zh-CN') u.lang = 'zh-CN';
        u.rate = 1.0; 
        u.onend = () => { if(onEndCallback) onEndCallback(); };
        u.onerror = (e) => { console.log('TTS Error', e); if(onEndCallback) onEndCallback(); };
        window.speechSynthesis.speak(u);
    }

    // --- ğŸ§ æ²‰æµ¸å¼é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ Audio Event é©±åŠ¨) ---
    let isImmersive = false;
    let playQueue = [];
    let playQueueIndex = 0;
    const silentDriver = document.getElementById('silentDriver');

    // ç›‘å¬é™éŸ³æ’­æ”¾å™¨çš„ç»“æŸäº‹ä»¶ï¼Œä»¥æ­¤æ¥é©±åŠ¨ä¸‹ä¸€ä¸ªåŠ¨ä½œ
    // è¿™æ¯” setTimeout é è°±ï¼Œå› ä¸º audio äº‹ä»¶åœ¨åå°ä¹Ÿä¼šè§¦å‘
    silentDriver.onended = function() {
        if (!isImmersive) return;
        // å¦‚æœåˆšåˆšæ’­å®Œçš„æ˜¯ delay (é™éŸ³)ï¼Œé‚£ä¹ˆç°åœ¨è¯¥æ’­ä¸‹ä¸€ä¸ªè¯äº†
        playQueueIndex++;
        processQueue();
    };

    function startImmersiveMode() {
        const unit = appData[currentUnitIdx];
        if (!unit || unit.words.length === 0) return alert('å½“å‰å•å…ƒæ²¡æœ‰å•è¯');
        isImmersive = true;
        document.getElementById('immersiveOverlay').style.display = 'flex';
        
        // æ›´æ–°é”å±åª’ä½“ä¿¡æ¯ (Media Session API)
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'å…‹è¯­å¬åŠ›å¤ä¹ ',
                artist: unit.name,
                album: 'Cro Helper'
            });
            navigator.mediaSession.setActionHandler('play', () => {});
            navigator.mediaSession.setActionHandler('pause', stopImmersiveMode);
        }

        playQueue = [];
        unit.words.forEach((w, idx) => {
            const hrText = fixCroText(w.hr).replace(/[\r\n]+/g, " ");
            const cnText = fixCroText(w.cn).replace(/[\r\n]+/g, " ");
            playQueue.push({ type: 'speak', text: hrText, lang: 'hr', uiHr: hrText, uiCn: cnText, rowIndex: idx });
            if (cnText && cnText.trim()) {
                playQueue.push({ type: 'speak', text: cnText, lang: 'zh-CN', uiHr: hrText, uiCn: cnText, rowIndex: idx });
            }
            playQueue.push({ type: 'delay' });
        });
        
        // é‡ç½®æ’­æ”¾å™¨å¹¶å¼€å§‹
        playQueueIndex = 0;
        // å…ˆæ’­æ”¾ä¸€ä¸ªæçŸ­çš„é™éŸ³æ¥æ¿€æ´» AudioContext
        silentDriver.src = SILENT_MP3;
        silentDriver.loop = false;
        silentDriver.play().then(() => {
            // è¿™é‡Œä¸é€šè¿‡ onended è§¦å‘ï¼Œè€Œæ˜¯æ‰‹åŠ¨å¼€å§‹ç¬¬ä¸€æ¬¡ process
            // å› ä¸ºç¬¬ä¸€æ¬¡ç‚¹å‡»å¾€å¾€æ˜¯åœ¨å‰å°
            processQueue();
        }).catch(() => {
            alert("è¯·ç‚¹å‡»å…è®¸æ’­æ”¾éŸ³é¢‘");
            processQueue();
        });
    }

    function stopImmersiveMode() {
        isImmersive = false;
        document.getElementById('immersiveOverlay').style.display = 'none';
        window.speechSynthesis.cancel();
        silentDriver.pause();
        document.querySelectorAll('.word-row').forEach(r => r.classList.remove('playing-now'));
    }

    function processQueue() {
        if (!isImmersive) return;
        if (playQueueIndex >= playQueue.length) {
            // å¾ªç¯æ’­æ”¾
            playQueueIndex = 0;
            // return alert('æ’­æ”¾å®Œæˆ'); // å¦‚æœä¸æƒ³å¾ªç¯ï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œ
        }

        const item = playQueue[playQueueIndex];

        // æ›´æ–° UI (é”å±ç•Œé¢ä¹Ÿä¼šå°è¯•æ›´æ–°)
        if (item.uiHr) {
            document.getElementById('immHr').innerText = item.uiHr;
            document.getElementById('immCn').innerText = item.uiCn;
            
            // æ›´æ–°é”å±ä¿¡æ¯
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata.title = item.uiHr;
                navigator.mediaSession.metadata.artist = item.uiCn;
            }

            if(item.rowIndex !== undefined) {
                document.querySelectorAll('.word-row').forEach(r => r.classList.remove('playing-now'));
                const row = document.getElementById(`word-row-${item.rowIndex}`);
                if(row) {
                    row.classList.add('playing-now');
                    row.scrollIntoView({behavior: "smooth", block: "center"});
                }
            }
        }

        if (item.type === 'delay') {
            // æ’­æ”¾ 1.2 ç§’çš„é™éŸ³ï¼Œä½œä¸ºé—´éš”
            // æ³¨æ„ï¼šå› ä¸º SILENT_MP3 æœ¬èº«åªæœ‰ 0.5s å·¦å³ï¼Œæˆ‘ä»¬éœ€è¦å˜æ…¢æ’­æ”¾é€Ÿåº¦æ¥å»¶é•¿æ—¶é—´
            // æˆ–è€… loop å‡ æ¬¡ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼šæ’­æ”¾ä¸€æ¬¡
            silentDriver.src = SILENT_MP3;
            silentDriver.playbackRate = 0.4; // å˜æ…¢ä»¥å¢åŠ å»¶è¿Ÿ
            silentDriver.play();
            // å½“è¿™ä¸ªé™éŸ³æ’­å®Œæ—¶ï¼Œonended ä¼šè§¦å‘ processQueue (index+1)

        } else if (item.type === 'speak') {
            // æœ—è¯»æ—¶ï¼Œä¸ºäº†é˜²æ­¢åå°æ€è¿›ç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿè®© silentDriver ä¿æŒæ’­æ”¾çŠ¶æ€ï¼ˆæ— é™å¾ªç¯ï¼‰
            // ä½†å£°éŸ³æå°æˆ–é™éŸ³
            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ª trickï¼šSpeak æ˜¯åŒæ­¥å‘èµ·çš„ï¼Œä½†æˆ‘ä»¬éœ€è¦ Speak å®Œæˆåæ‰ç»§ç»­
            
            // 1. æ’­æ”¾ä¸€ä¸ªæ— é™é•¿çš„é™éŸ³æ¥ä¿æ´»
            silentDriver.src = SILENT_MP3; 
            silentDriver.loop = true;
            silentDriver.play().catch(()=>{});

            speakLocal(item.text, item.lang, () => {
                // 2. Speak ç»“æŸäº†
                // åœæ­¢ä¿æ´»é™éŸ³
                silentDriver.pause();
                silentDriver.loop = false;
                
                // æ‰‹åŠ¨è§¦å‘ä¸‹ä¸€æ­¥
                playQueueIndex++;
                processQueue();
            });
        }
    }

    // --- å¸¸è§„åŠŸèƒ½ (ä¸å˜) ---
    let dragEl = null; let pressTimer = null; let isDragActive = false; let startY = 0;
    
    function fixCroText(text) {
        if (!text) return "";
        let t = text.normalize('NFC');
        t = t.replace(/c\s*Ë‡/g, "Ä").replace(/C\s*Ë‡/g, "ÄŒ").replace(/s\s*Ë‡/g, "Å¡").replace(/S\s*Ë‡/g, "Å ").replace(/z\s*Ë‡/g, "Å¾").replace(/Z\s*Ë‡/g, "Å½");
        return t;
    }

    function render() {
        const list = document.getElementById('wordListContainer');
        const select = document.getElementById('unitSelect');
        const insertSelect = document.getElementById('insertAfterSelect');
        const nameInput = document.getElementById('unitNameInput');
        list.innerHTML = ''; select.innerHTML = ''; insertSelect.innerHTML = '<option value="-1">ç½®é¡¶æ·»åŠ </option>';
        if (appData.length === 0) { nameInput.placeholder = "å•å…ƒåç§°"; list.innerHTML = '<div style="text-align:center;color:#999;padding:40px">æš‚æ— å•è¯</div>'; return; }
        appData.forEach((u, i) => {
            if (u.name !== "ğŸ“• é”™é¢˜æœ¬" || i === currentUnitIdx) { select.add(new Option(u.name, i)); }
            insertSelect.add(new Option(`åœ¨ ${u.name} å`, i));
        });
        select.value = currentUnitIdx; 
        if(currentUnitIdx !== -1 && appData[currentUnitIdx]) { nameInput.placeholder = `ç•™ç©ºåˆ™æ·»åŠ åˆ°: ${appData[currentUnitIdx].name}`; }
        const unit = appData[currentUnitIdx];
        if(!unit) return;
        unit.words.forEach((w, i) => {
            const row = document.createElement('div');
            row.className = 'word-row';
            row.id = `word-row-${i}`;
            const safeHr = fixCroText(w.hr); const safeCn = fixCroText(w.cn);
            row.innerHTML = `
                <div class="left-part">
                    <span onclick="speakLocal('${safeHr.replace(/'/g, "\\'").replace(/[\r\n]+/g, " ")}', 'hr')">${audioIconSvg}</span>
                    <div class="col-hr" ondblclick="enableEdit(this, ${i}, 'hr')">${safeHr}</div>
                </div>
                <div class="col-cn" ondblclick="enableEdit(this, ${i}, 'cn')">${safeCn}</div>
                <div class="action-area">
                    <div class="del-word-btn" onclick="delWord(${i})">âœ•</div>
                    <div class="drag-handle">â‰¡</div>
                </div>
            `;
            const handle = row.querySelector('.drag-handle');
            handle.addEventListener('touchstart', handleTouchStart, {passive: false});
            handle.addEventListener('touchmove', handleTouchMove, {passive: false});
            handle.addEventListener('touchend', handleTouchEnd);
            handle.addEventListener('touchcancel', handleTouchEnd);
            handle.addEventListener('mousedown', handleMouseDown);
            list.appendChild(row);
        });
    }

    function jumpToUnit() { currentUnitIdx = parseInt(document.getElementById('unitSelect').value); exitNotebookMode(); saveState(); render(); }
    function changeUnit(dir) { let n = currentUnitIdx + dir; if(n >= 0 && n < appData.length) { currentUnitIdx = n; exitNotebookMode(); saveState(); render(); } }
    function goToNotebook() { if(notebook.length===0) return alert('ç©º'); localStorage.setItem('cro_viewing_notebook', 'true'); const name="ğŸ“• é”™é¢˜æœ¬"; const idx=appData.findIndex(u=>u.name===name); if(idx>-1) appData[idx].words=notebook; else appData.unshift({name, words:notebook}); currentUnitIdx = (idx > -1) ? idx : 0; saveState(); render(); }
    function exitNotebookMode() { localStorage.setItem('cro_viewing_notebook', 'false'); }
    function saveState() { localStorage.setItem('cro_last_unit_idx', currentUnitIdx); }
    function saveData() { localStorage.setItem('cro_v52', JSON.stringify(appData)); saveState(); }
    function handleTouchStart(e) { startY = e.touches[0].clientY; const handle = this; const row = handle.closest('.word-row'); pressTimer = setTimeout(() => { isDragActive = true; dragEl = row; dragEl.classList.add('dragging'); handle.classList.add('active'); if(navigator.vibrate) navigator.vibrate(50); }, 800); }
    function handleTouchMove(e) { if (!isDragActive) { if (Math.abs(e.touches[0].clientY - startY) > 10) clearTimeout(pressTimer); return; } if (e.cancelable) e.preventDefault(); performDrag(e.touches[0].clientX, e.touches[0].clientY); }
    function handleTouchEnd(e) { clearTimeout(pressTimer); if (isDragActive) stopDragging(); isDragActive = false; }
    function handleMouseDown(e) { dragEl = this.closest('.word-row'); isDragActive = true; dragEl.classList.add('dragging'); this.classList.add('active'); document.addEventListener('mousemove', handleMouseMoveGlobal); document.addEventListener('mouseup', handleMouseUpGlobal); e.preventDefault(); }
    function handleMouseMoveGlobal(e) { if (!isDragActive) return; e.preventDefault(); performDrag(e.clientX, e.clientY); }
    function handleMouseUpGlobal(e) { stopDragging(); document.removeEventListener('mousemove', handleMouseMoveGlobal); document.removeEventListener('mouseup', handleMouseUpGlobal); }
    function performDrag(x, y) { const target = document.elementFromPoint(x, y); const targetRow = target ? target.closest('.word-row') : null; if (targetRow && targetRow !== dragEl) { const list = document.getElementById('wordListContainer'); const children = Array.from(list.children); const dragIndex = children.indexOf(dragEl); const targetIndex = children.indexOf(targetRow); if (dragIndex < targetIndex) list.insertBefore(dragEl, targetRow.nextSibling); else list.insertBefore(dragEl, targetRow); } }
    function stopDragging() { if(dragEl) { dragEl.classList.remove('dragging'); const handle = dragEl.querySelector('.drag-handle'); if(handle) handle.classList.remove('active'); rebuildDataFromDOM(); } isDragActive = false; dragEl = null; }
    function rebuildDataFromDOM() { const rows = document.querySelectorAll('.word-row'); const newWords = []; rows.forEach(row => { newWords.push({hr: row.querySelector('.col-hr').innerText, cn: row.querySelector('.col-cn').innerText}); }); appData[currentUnitIdx].words = newWords; saveData(); render(); }
    function enableEdit(el, idx, field) { el.contentEditable = true; el.focus(); el.classList.add('editing'); el.onkeydown = null; el.onblur = () => { el.contentEditable = false; el.classList.remove('editing'); updateWord(idx, field, el.innerText); }; }
    function updateWord(idx, field, val) { const cleanVal = fixCroText(val); appData[currentUnitIdx].words[idx][field] = cleanVal; if(appData[currentUnitIdx].name === "ğŸ“• é”™é¢˜æœ¬") { if(notebook[idx]) notebook[idx][field] = cleanVal; localStorage.setItem('cro_notebook', JSON.stringify(notebook)); } saveData(); }
    function importWords() {
        let name = document.getElementById('unitNameInput').value.trim(); const text = document.getElementById('importText').value.trim(); const after = parseInt(document.getElementById('insertAfterSelect').value);
        if(!text) return; let targetUnitIndex = -1; if (!name && currentUnitIdx !== -1) targetUnitIndex = currentUnitIdx;
        const newWords = text.split('\n').map(l => { let i = l.search(/[\u4e00-\u9fa5|0-9|,|;|ï¼Œ|ï¼›]/); return i!==-1 ? {hr:fixCroText(l.slice(0,i).trim()), cn:fixCroText(l.slice(i).replace(/^[,;ï¼Œï¼›\s]+/,"").trim())} : {hr:fixCroText(l.trim()), cn:""}; }).filter(w => w.hr);
        if (targetUnitIndex !== -1) { const unit = appData[targetUnitIndex]; newWords.forEach(nw => { const existIdx = unit.words.findIndex(old => old.hr.toLowerCase() === nw.hr.toLowerCase()); if (existIdx !== -1) unit.words[existIdx].cn = nw.cn; else unit.words.push(nw); }); alert(`å·²æ·»åŠ åˆ°: "${unit.name}"`); } 
        else { if(!name) name = "æ–°å•å…ƒ"; if(after === -1) appData.unshift({name, words: newWords}); else appData.splice(after+1, 0, {name, words: newWords}); alert(`å·²åˆ›å»º: "${name}"`); }
        saveData(); render(); togglePanel('importPanel'); document.getElementById('importText').value = ''; 
    }
    function setMode(mode) { currentMode = mode; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('mode-' + mode).classList.add('active'); }
    function startChallenge() { const unit = appData[currentUnitIdx]; if(!unit || unit.words.length === 0) return; speakLocal(' ', 'hr'); let base = [...unit.words]; let extra = [...base].sort(() => Math.random() - 0.5).slice(0, Math.ceil(base.length * 0.25)); challengeList = [...base, ...extra].sort(() => Math.random() - 0.5); document.getElementById('challengeOverlay').style.display = 'flex'; showQuestion(); }
    function showQuestion() {
        if(challengeList.length === 0) { alert("æ­å–œï¼å¤ä¹ å®Œæˆ"); return exitChallenge(); }
        const main = document.getElementById('challengeMain'); main.innerHTML = ''; document.getElementById('challengeProgress').innerText = `å‰©ä½™: ${challengeList.length}`;
        const current = challengeList[0];
        if(document.getElementById('autoVoice').checked) speakLocal(current.hr, 'hr');
        let displayMode = currentMode;
        if (currentMode === 'mixed') { const r = Math.random(); if (challengeList.length >= 4 && r < 0.3) displayMode = 'match'; else if (r < 0.65) displayMode = 'quiz'; else displayMode = 'spell'; }
        if(displayMode === 'quiz') {
            main.innerHTML = `<div style="font-size:28px; margin-bottom:30px; font-weight:bold; color:#6366f1; text-align:center; white-space: pre-wrap">${current.hr}</div>`;
            const options = [current]; const all = appData[currentUnitIdx].words;
            while(options.length < Math.min(all.length, 4)) { const r = all[Math.floor(Math.random() * all.length)]; if(!options.includes(r)) options.push(r); }
            options.sort(() => Math.random() - 0.5).forEach(opt => { const btn = document.createElement('div'); btn.className = 'quiz-option'; btn.innerText = opt.cn; btn.onclick = () => { if(opt === current) { btn.classList.add('correct'); setTimeout(() => { challengeList.shift(); showQuestion(); }, 500); } else { btn.classList.add('wrong'); addToNotebook(current); } }; main.appendChild(btn); });
        } 
        else if (displayMode === 'match') {
            const num = Math.min(challengeList.length, 4); const currentBatch = challengeList.slice(0, num);
            const items = [...currentBatch.map(s => ({t: s.hr, id: s.hr, type:'hr'})), ...currentBatch.map(s => ({t: s.cn, id: s.hr, type:'cn'}))].sort(() => Math.random() - 0.5);
            main.innerHTML = `<div class="match-grid"></div>`; const grid = main.querySelector('.match-grid'); let first = null; let matchedCount = 0;
            items.forEach(item => { const div = document.createElement('div'); div.className = 'match-item'; div.innerText = item.t; div.onclick = () => { if(div.classList.contains('hidden') || div.classList.contains('match-correct')) return; if(item.type === 'hr') speakLocal(item.t, 'hr'); div.classList.add('selected'); if(!first) { first = {div, item}; } else { if(first.div === div) return; if(first.item.id === item.id) { first.div.className = 'match-item match-correct'; div.className = 'match-item match-correct'; matchedCount++; const fDiv = first.div; const sDiv = div; setTimeout(() => { fDiv.classList.add('hidden'); sDiv.classList.add('hidden'); if(matchedCount === num) { challengeList.splice(0, num); showQuestion(); } }, 400); } else { div.className = 'match-item match-wrong'; first.div.className = 'match-item match-wrong'; addToNotebook(challengeList.find(c => c.hr === item.id || c.hr === first.item.id)); const fDiv = first.div; const sDiv = div; setTimeout(() => { sDiv.className = 'match-item'; fDiv.className = 'match-item'; }, 500); } first = null; } }; grid.appendChild(div); });
        }
        else if (displayMode === 'spell') {
            main.innerHTML = `<div class="spelling-container"><div style="font-size:24px; color:#333; margin-bottom:20px; font-weight:bold; white-space:pre-wrap;">${current.cn}</div><div id="spellFeedback" class="spelling-feedback"></div><input type="text" id="spellInput" class="spelling-input" placeholder="è¾“å…¥å…‹è¯­ (å¬å†™)" autocomplete="off"><div class="special-chars">${['Ä','Ä‡','Ä‘','Å¡','Å¾'].map(c => `<div class="char-btn" onclick="typeChar('${c}')">${c}</div>`).join('')}</div><button class="start-btn" onclick="checkSpelling()">æäº¤éªŒè¯</button><div style="margin-top:20px; color:#666; font-size:14px" onclick="speakLocal('${current.hr.replace(/'/g, "\\'").replace(/[\r\n]+/g, " ")}', 'hr')">ğŸ”Š é‡å¬</div></div>`;
            const input = document.getElementById('spellInput'); input.focus(); input.onkeydown = (e) => { if(e.key === 'Enter') checkSpelling(); };
        }
    }
    function typeChar(char) { const input = document.getElementById('spellInput'); input.value += char; input.focus(); }
    function checkSpelling() { const input = document.getElementById('spellInput'); const feedback = document.getElementById('spellFeedback'); const current = challengeList[0]; const clean = (str) => str.normalize('NFC').toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, " ").replace(/\s+/g, " ").trim(); const userVal = clean(input.value); const targetVal = clean(current.hr); if (userVal === targetVal) { input.classList.add('success'); feedback.style.color = 'var(--success)'; feedback.innerText = "æ­£ç¡®! âœ…"; setTimeout(() => { challengeList.shift(); showQuestion(); }, 1000); } else { input.classList.add('error'); feedback.style.color = 'var(--danger)'; feedback.innerText = `é”™è¯¯! ç­”æ¡ˆ: ${current.hr}`; addToNotebook(current); setTimeout(() => { input.classList.remove('error'); }, 2000); } }
    function addToNotebook(word) { if(!notebook.some(w => w.hr === word.hr)) { notebook.push(word); localStorage.setItem('cro_notebook', JSON.stringify(notebook)); } if(currentMode === 'quiz') { challengeList.push(challengeList.shift()); showQuestion(); } }
    function removeDuplicates() { if(!confirm('ç¡®å®šæ¸…ç†é‡å¤ï¼Ÿ')) return; let c = 0; appData.forEach(u => { const m = new Map(), cl = []; u.words.forEach(w => { const k=w.hr.toLowerCase().trim(); if(!m.has(k)){m.set(k,1);cl.push(w)}else c++ }); u.words=cl; }); saveData(); render(); alert(`æ¸…ç†äº† ${c} ä¸ªé‡å¤`); }
    function delWord(i) { if(confirm('åˆ é™¤ï¼Ÿ')) { if(appData[currentUnitIdx].name==="ğŸ“• é”™é¢˜æœ¬") { notebook.splice(i,1); localStorage.setItem('cro_notebook',JSON.stringify(notebook)); } appData[currentUnitIdx].words.splice(i,1); saveData(); render(); }}
    function deleteCurrentUnit() { if(confirm('âš ï¸ åˆ å•å…ƒï¼Ÿ')) { if(appData[currentUnitIdx].name==="ğŸ“• é”™é¢˜æœ¬") { notebook=[]; localStorage.setItem('cro_notebook',JSON.stringify(notebook)); } appData.splice(currentUnitIdx,1); currentUnitIdx=0; saveData(); render(); }}
    function togglePanel(id) { const p=document.getElementById(id); p.style.display=(p.style.display==='block'?'none':'block'); }
    function copyFullCode() { const a=document.getElementById('codeText'); a.value=JSON.stringify(appData); a.select(); document.execCommand('copy'); }
    function downloadAll() { const b=new Blob([JSON.stringify(appData,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`cro_backup.json`; a.click(); }
    function handleFileImport(i) { const r=new FileReader(); r.onload=(e)=>{ appData=[...JSON.parse(e.target.result),...appData]; saveData(); render(); }; r.readAsText(i.files[0]); }
    function importFromCode() { try { appData=[...JSON.parse(document.getElementById('codeText').value),...appData]; saveData(); render(); alert('æˆåŠŸ'); } catch(e){alert('é”™è¯¯');} }
    function exitChallenge() { document.getElementById('challengeOverlay').style.display='none'; }
    if (localStorage.getItem('cro_viewing_notebook') === 'true') { goToNotebook(); } else { render(); }
</script>
</body>
</html>
