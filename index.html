<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…‹è¯­åŠ©æ‰‹ V56 (åŠŸèƒ½å…¨é€šç‰ˆ)</title>
    <style>
        :root {
            --primary: #0056b3;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f7f9fc;
            --drag-bg: #fff9c4;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); margin: 0; padding-top: 110px;
            color: #333; overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent; padding-bottom: 60px;
        }
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        .sticky-header { position: fixed; top: 0; left: 0; width: 100%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1000; padding: 15px; box-sizing: border-box; padding-top: max(15px, env(safe-area-inset-top)); }
        .header-top { display: flex; justify-content: space-between; margin-bottom: 12px; }
        h1 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }
        .nav-controls { display: flex; gap: 8px; max-width: 800px; margin: 0 auto; align-items: center; }
        .nav-btn { background: #f0f2f5; color: #555; border: none; padding: 10px 18px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        select { flex: 1; padding: 10px; border: 1px solid #e1e4e8; border-radius: 10px; font-size: 15px; text-align: center; background: white; color: #333; font-weight: 600; }
        .listen-btn { width: 15%; background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; padding: 10px; border-radius: 10px; font-size: 18px; }
        .notebook-btn { width: 15%; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; padding: 10px; border-radius: 10px; font-size: 18px; }
        .container { max-width: 800px; margin: 0 auto; padding: 0 15px 120px 15px; }
        .challenge-box { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 5px; }
        .mode-btn { padding: 10px 4px; border-radius: 10px; border: 1px solid #eee; font-size: 13px; background: #f9f9f9; font-weight: 600; color: #666; cursor: pointer;}
        .mode-btn.active { background: #6366f1; color: white; border-color: #6366f1; }
        .start-btn { width: 100%; margin-top: 15px; padding: 16px; border-radius: 15px; background: linear-gradient(135deg, #6366f1, #a855f7); color: white; border: none; font-size: 18px; font-weight: bold; }
        .word-row { display: flex; padding: 16px; background: white; border-radius: 12px; margin-bottom: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .word-row.playing-now { border: 2px solid #0ea5e9; background-color: #f0f9ff; }
        .left-part { flex: 1; display: flex; align-items: flex-start; min-width: 0; margin-right: 10px; }
        .col-hr { font-weight: 600; white-space: pre-wrap; line-height: 1.4; }
        .col-cn { flex: 0 0 auto; max-width: 35%; text-align: right; color: #666; font-size: 14px; }
        .icon-audio { width: 22px; height: 22px; margin-right: 10px; fill: var(--primary); flex-shrink: 0; }
        .action-area { flex: 0 0 40px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .del-word-btn { color: #ddd; font-size: 16px; }
        .panel { display: none; background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .footer-del-btn { width: 100%; padding: 15px; background: #fff; border: 2px solid #ffebeb; color: var(--danger); border-radius: 12px; font-weight: bold; margin-top: 30px; }
        
        /* æ²‰æµ¸æ¨¡å¼æ ·å¼ */
        #immersiveOverlay { display: none; position: fixed; inset: 0; background: #000; z-index: 3000; color: #fff; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; }
        .immersive-word { font-size: 34px; font-weight: bold; margin-bottom: 20px; min-height: 50px;}
        .immersive-cn { font-size: 22px; color: #888; margin-bottom: 60px; min-height: 30px;}
        .ctrl-row { display: flex; gap: 20px; align-items: center; }
        .imm-btn { width: 60px; height: 60px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 22px; border: 1px solid #444; }
        
        /* æŒ‘æˆ˜æ¨¡å¼è¦†ç›–å±‚ */
        #challengeOverlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; padding-top: env(safe-area-inset-top); }
        .challenge-header { display:flex; justify-content: space-between; padding:20px; border-bottom:1px solid #eee; align-items: center;}
        .challenge-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;}
        .quiz-option { width: 100%; max-width: 400px; padding: 18px; margin-bottom: 12px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; }
        .quiz-option.correct { background: var(--success); color: white; border-color: var(--success); }
        .quiz-option.wrong { background: var(--danger); color: white; border-color: var(--danger); }
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; }
        .match-item { padding: 22px 10px; border: 2px solid #f0f0f0; border-radius: 15px; text-align: center; background: #fff; color:#333; }
        .match-item.selected { border-color: #6366f1; background: #f5f3ff; }
        .match-item.match-correct { background: var(--success) !important; color: white !important; opacity: 0.3; }
        .spelling-input { width: 100%; padding: 15px; font-size: 20px; text-align: center; border: 2px solid #6366f1; border-radius: 12px; margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-top">
        <h1>ğŸ‡­ğŸ‡· å…‹è¯­åŠ©æ‰‹ V56</h1>
        <button class="nav-btn" style="padding: 6px 12px; font-size: 12px; background:none; border:1px solid #eee" onclick="togglePanel('syncPanel')">âš™ï¸ ç®¡ç†</button>
    </div>
    <div class="nav-controls">
        <button class="nav-btn" onclick="changeUnit(1)">â†</button>
        <select id="unitSelect" onchange="jumpToUnit()"></select>
        <button class="nav-btn" onclick="changeUnit(-1)">â†’</button>
        <button class="listen-btn" onclick="openImmersive()">ğŸ§</button>
        <button class="notebook-btn" onclick="goToNotebook()">ğŸ“•</button>
    </div>
</div>

<div class="container">
    <div class="challenge-box">
        <div class="mode-selector">
            <div class="mode-btn active" id="mode-quiz" onclick="setMode('quiz')">é€‰æ‹©</div>
            <div class="mode-btn" id="mode-match" onclick="setMode('match')">è¿è¿çœ‹</div>
            <div class="mode-btn" id="mode-spell" onclick="setMode('spell')">æ‹¼å†™</div>
            <div class="mode-btn" id="mode-mixed" onclick="setMode('mixed')">æ··åˆ</div>
        </div>
        <button class="start-btn" onclick="startChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div id="syncPanel" class="panel">
        <div style="margin-bottom: 15px;">
            <label style="font-size:12px; color:#555;">ğŸ—£ï¸ é€‰æ‹©å…‹è¯­å‘éŸ³äºº:</label>
            <select id="voiceSelect" onchange="saveVoiceSelection()"></select>
        </div>
        <button class="mode-btn" style="width:100%; margin-bottom:8px;" onclick="document.getElementById('fileInput').click()">â¬†ï¸ å¯¼å…¥JSONæ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFileImport(this)">
        <button class="mode-btn" style="width:100%; margin-bottom:15px;" onclick="downloadAll()">â¬‡ï¸ ä¸‹è½½å¤‡ä»½</button>
        <textarea id="codeText" class="input-box" style="height:60px;" placeholder="ç²˜è´´å…¨ç åˆ°æ­¤å¤„..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <button class="mode-btn" onclick="copyFullCode()">å¤åˆ¶å…¨ç </button>
            <button class="mode-btn" onclick="importFromCode()">ä»£ç å¯¼å…¥</button>
        </div>
    </div>

    <div style="text-align:center; color:#6366f1; margin: 20px 0; cursor:pointer; font-weight:bold" onclick="togglePanel('importPanel')">ï¼‹ å½•å…¥æ–°è¯</div>
    <div id="importPanel" class="panel">
        <input type="text" id="unitNameInput" class="input-box" placeholder="å•å…ƒåç§° (ä¸å¡«åˆ™æ·»åŠ åˆ°å½“å‰å•å…ƒ)">
        <textarea id="importText" class="input-box" style="height:100px" placeholder="dva 2"></textarea>
        <button class="start-btn" style="margin-top:0" onclick="importWords()">ç¡®è®¤ä¿å­˜</button>
    </div>

    <div id="wordListContainer"></div>
    <button class="footer-del-btn" onclick="deleteCurrentUnit()">ğŸ—‘ï¸ åˆ é™¤å½“å‰å•å…ƒ</button>
</div>

<div id="immersiveOverlay">
    <div id="immHr" class="immersive-word">åŠ è½½ä¸­...</div>
    <div id="immCn" class="immersive-cn"></div>
    <div class="ctrl-row">
        <div class="imm-btn" onclick="prevWord()">â®</div>
        <div id="immPlayBtn" class="imm-btn" style="background:#0ea5e9" onclick="togglePause()">â¸</div>
        <div class="imm-btn" onclick="nextWord()">â­</div>
        <div class="imm-btn" style="color:var(--danger)" onclick="closeImmersive()">âœ•</div>
    </div>
    <div class="immersive-tip">ğŸ§ æ”¯æŒé”å±æ’­æ”¾<br>å¦‚å‘éŸ³åœé¡¿ï¼Œè¯·å°è¯•æ‰‹åŠ¨ç‚¹å‡»æš‚åœ/æ’­æ”¾</div>
</div>

<div id="challengeOverlay">
    <div class="challenge-header">
        <button onclick="exitChallenge()" style="border:none; background:none; font-size:24px; color:#999">âœ•</button>
        <div id="challengeProgress" style="font-weight:bold; color:#6366f1">0 / 0</div>
    </div>
    <div id="challengeMain" class="challenge-body"></div>
</div>

<audio id="engineAudio" loop playsinline src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAASAAAAAAAASAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAA"></audio>

<script>
    const audioIconSvg = `<svg class="icon-audio" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;

    let appData = JSON.parse(localStorage.getItem('cro_v56')) || JSON.parse(localStorage.getItem('cro_v55')) || [];
    let notebook = JSON.parse(localStorage.getItem('cro_notebook')) || [];
    let currentUnitIdx = parseInt(localStorage.getItem('cro_last_unit_idx')) || 0;
    let selectedVoiceURI = localStorage.getItem('cro_selected_voice') || '';
    let voices = [];

    // --- TTSä¸å‘åŠ¨æœºé€»è¾‘ ---
    let isImmersive = false;
    let isPaused = false;
    let playList = [];
    let playIdx = 0;
    const engine = document.getElementById('engineAudio');

    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        if(!select) return;
        select.innerHTML = '<option value="">-- ç³»ç»Ÿé»˜è®¤ --</option>';
        voices.forEach(v => {
            if (v.lang.includes('hr') || v.lang.includes('HR')) {
                select.add(new Option(v.name + (v.localService ? ' [æœ¬åœ°]' : ''), v.voiceURI));
            }
        });
        if(selectedVoiceURI) select.value = selectedVoiceURI;
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 500);

    function saveVoiceSelection() {
        selectedVoiceURI = document.getElementById('voiceSelect').value;
        localStorage.setItem('cro_selected_voice', selectedVoiceURI);
    }

    // å…¨å±€å‘éŸ³ä¿æ´»å˜é‡
    window.activeUtter = null;
    function speak(text, lang, callback) {
        window.speechSynthesis.cancel();
        if(isPaused && isImmersive) return;

        window.activeUtter = new SpeechSynthesisUtterance(text);
        const v = voices.find(i => i.voiceURI === selectedVoiceURI);
        if(v) window.activeUtter.voice = v;
        window.activeUtter.lang = lang === 'hr' ? 'hr-HR' : 'zh-CN';
        window.activeUtter.rate = 1.0;

        window.activeUtter.onend = () => { if(callback) callback(); };
        window.activeUtter.onerror = () => { if(callback) callback(); };
        window.speechSynthesis.speak(window.activeUtter);
    }

    // --- æ²‰æµ¸æ’­æ”¾é€»è¾‘ ---
    function openImmersive() {
        const unit = appData[currentUnitIdx];
        if(!unit || unit.words.length === 0) return alert('å½“å‰å•å…ƒä¸ºç©º');
        isImmersive = true; isPaused = false;
        document.getElementById('immersiveOverlay').style.display = 'flex';
        document.getElementById('immPlayBtn').innerText = 'â¸';
        
        playList = [];
        unit.words.forEach((w, i) => {
            playList.push({ type: 'hr', text: w.hr, idx: i });
            if(w.cn) playList.push({ type: 'cn', text: w.cn, idx: i });
            playList.push({ type: 'gap', duration: 1200, idx: i });
        });
        playIdx = 0;
        engine.play().catch(()=>{}); // å¯åŠ¨ä¿æ´»å‘åŠ¨æœº
        runLoop();
    }

    function runLoop() {
        if(!isImmersive || isPaused) return;
        if(playIdx >= playList.length) playIdx = 0;

        const item = playList[playIdx];
        const word = appData[currentUnitIdx].words[item.idx];
        
        document.getElementById('immHr').innerText = word.hr;
        document.getElementById('immCn').innerText = word.cn || '';

        // é«˜äº®å•è¯è¡Œ
        document.querySelectorAll('.word-row').forEach(r => r.classList.remove('playing-now'));
        const row = document.getElementById(`word-row-${item.idx}`);
        if(row) { row.classList.add('playing-now'); row.scrollIntoView({behavior:'smooth', block:'center'}); }

        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({ title: word.hr, artist: word.cn });
            navigator.mediaSession.setActionHandler('play', togglePause);
            navigator.mediaSession.setActionHandler('pause', togglePause);
            navigator.mediaSession.setActionHandler('nexttrack', nextWord);
            navigator.mediaSession.setActionHandler('previoustrack', prevWord);
        }

        if(item.type === 'gap') {
            setTimeout(() => { if(!isPaused) { playIdx++; runLoop(); } }, item.duration);
        } else {
            speak(item.text, item.type, () => { if(!isPaused) { playIdx++; runLoop(); } });
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('immPlayBtn');
        if(isPaused) { window.speechSynthesis.cancel(); btn.innerText = 'â–¶ï¸'; } 
        else { btn.innerText = 'â¸'; runLoop(); }
    }

    function nextWord() { window.speechSynthesis.cancel(); let n = playIdx + 1; while(n < playList.length && playList[n].type !== 'hr') n++; playIdx = n >= playList.length ? 0 : n; if(isPaused) togglePause(); else runLoop(); }
    function prevWord() { window.speechSynthesis.cancel(); let p = playIdx - 1; while(p >= 0 && playList[p].type !== 'hr') p--; playIdx = p < 0 ? 0 : p; if(isPaused) togglePause(); else runLoop(); }
    function closeImmersive() { isImmersive = false; window.speechSynthesis.cancel(); engine.pause(); document.getElementById('immersiveOverlay').style.display = 'none'; }

    // --- æ ¸å¿ƒåŠŸèƒ½ (å¯¼å…¥/å¯¼å‡º/æŒ‘æˆ˜) ---
    function render() {
        const list = document.getElementById('wordListContainer');
        const select = document.getElementById('unitSelect');
        list.innerHTML = ''; select.innerHTML = '';
        if(appData.length === 0) return;
        appData.forEach((u, i) => select.add(new Option(u.name, i)));
        select.value = currentUnitIdx;
        const unit = appData[currentUnitIdx];
        unit.words.forEach((w, i) => {
            const row = document.createElement('div');
            row.className = 'word-row'; row.id = `word-row-${i}`;
            row.innerHTML = `
                <div class="left-part" onclick="speak('${w.hr.replace(/'/g,"\\'")}', 'hr')">
                    ${audioIconSvg} <div class="col-hr">${w.hr}</div>
                </div>
                <div class="col-cn">${w.cn}</div>
                <div class="action-area"><div class="del-word-btn" onclick="delWord(${i})">âœ•</div></div>
            `;
            list.appendChild(row);
        });
    }

    function handleFileImport(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                appData = [...data, ...appData];
                saveData(); render(); alert('æ–‡ä»¶å¯¼å…¥æˆåŠŸ');
            } catch(err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
        };
        reader.readAsText(input.files[0]);
    }

    function importFromCode() {
        try {
            const data = JSON.parse(document.getElementById('codeText').value);
            appData = [...data, ...appData];
            saveData(); render(); alert('ä»£ç å¯¼å…¥æˆåŠŸ');
        } catch(e) { alert('å¯¼å…¥ä»£ç æ— æ•ˆ'); }
    }

    function importWords() {
        const name = document.getElementById('unitNameInput').value || `æ–°å•å…ƒ ${appData.length+1}`;
        const text = document.getElementById('importText').value.trim();
        if(!text) return;
        const newWords = text.split('\n').map(l => {
            let i = l.search(/[\u4e00-\u9fa5|0-9]/);
            return i!==-1 ? {hr:l.slice(0,i).trim(), cn:l.slice(i).trim()} : {hr:l.trim(), cn:""};
        }).filter(w => w.hr);
        appData.push({name, words: newWords});
        saveData(); render(); togglePanel('importPanel');
    }

    function delWord(i) { if(confirm('åˆ é™¤æ­¤è¯ï¼Ÿ')) { appData[currentUnitIdx].words.splice(i,1); saveData(); render(); } }
    function deleteCurrentUnit() { if(confirm('ç¡®å®šåˆ é™¤æ•´ä¸ªå•å…ƒï¼Ÿ')) { appData.splice(currentUnitIdx, 1); currentUnitIdx = 0; saveData(); render(); } }
    function jumpToUnit() { currentUnitIdx = parseInt(document.getElementById('unitSelect').value); saveData(); render(); }
    function changeUnit(dir) { let n = currentUnitIdx + dir; if(n>=0 && n<appData.length) { currentUnitIdx=n; saveData(); render(); } }
    function togglePanel(id) { const p = document.getElementById(id); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function saveData() { localStorage.setItem('cro_v56', JSON.stringify(appData)); localStorage.setItem('cro_last_unit_idx', currentUnitIdx); }
    function copyFullCode() { const ta = document.getElementById('codeText'); ta.value = JSON.stringify(appData); ta.select(); document.execCommand('copy'); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }
    function downloadAll() { const blob = new Blob([JSON.stringify(appData,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cro_words.json'; a.click(); }

    // --- æŒ‘æˆ˜æ¨¡å¼ ---
    let challengeList = [];
    let currentMode = 'quiz';
    function setMode(m) { currentMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.id==='mode-'+m)); }
    function startChallenge() {
        const unit = appData[currentUnitIdx];
        if(!unit || unit.words.length === 0) return;
        challengeList = [...unit.words].sort(() => Math.random() - 0.5);
        document.getElementById('challengeOverlay').style.display = 'flex';
        showQuestion();
    }
    function showQuestion() {
        if(challengeList.length === 0) { alert("æŒ‘æˆ˜å®Œæˆï¼"); return exitChallenge(); }
        const main = document.getElementById('challengeMain'); main.innerHTML = '';
        const current = challengeList[0];
        document.getElementById('challengeProgress').innerText = `å‰©ä½™: ${challengeList.length}`;
        speak(current.hr, 'hr');
        
        if(currentMode === 'quiz' || (currentMode === 'mixed' && Math.random() > 0.5)) {
            main.innerHTML = `<div style="font-size:28px; margin-bottom:30px; font-weight:bold">${current.hr}</div>`;
            let options = [current, ...appData[currentUnitIdx].words.filter(w=>w!==current).sort(()=>Math.random()-0.5).slice(0,3)].sort(()=>Math.random()-0.5);
            options.forEach(opt => {
                const btn = document.createElement('div'); btn.className = 'quiz-option'; btn.innerText = opt.cn;
                btn.onclick = () => { if(opt===current) { btn.classList.add('correct'); setTimeout(() => { challengeList.shift(); showQuestion(); }, 500); } else btn.classList.add('wrong'); };
                main.appendChild(btn);
            });
        } else if (currentMode === 'match') {
            main.innerHTML = '<div class="match-grid"></div>';
            const grid = main.querySelector('.match-grid');
            const sub = challengeList.slice(0, 4);
            const items = [...sub.map(s=>({t:s.hr, id:s.hr, type:'hr'})), ...sub.map(s=>({t:s.cn, id:s.hr, type:'cn'}))].sort(()=>Math.random()-0.5);
            let first = null;
            items.forEach(item => {
                const div = document.createElement('div'); div.className = 'match-item'; div.innerText = item.t;
                div.onclick = () => {
                    if(div.classList.contains('match-correct')) return;
                    div.classList.add('selected');
                    if(!first) first = {div, item};
                    else {
                        if(first.item.id === item.id && first.item.type !== item.type) {
                            first.div.className = 'match-item match-correct'; div.className = 'match-item match-correct';
                            if(grid.querySelectorAll('.match-correct').length === sub.length*2) { setTimeout(()=>{ challengeList.splice(0,4); showQuestion(); }, 600); }
                        } else { first.div.classList.remove('selected'); div.classList.remove('selected'); }
                        first = null;
                    }
                };
                grid.appendChild(div);
            });
        } else {
            main.innerHTML = `<div style="font-size:24px; margin-bottom:20px">${current.cn}</div><input type="text" id="spellInp" class="spelling-input" placeholder="è¾“å…¥å…‹è¯­..."><button class="start-btn" onclick="checkSpell()">æäº¤</button>`;
            document.getElementById('spellInp').focus();
        }
    }
    window.checkSpell = () => {
        const inp = document.getElementById('spellInp'); const cur = challengeList[0];
        if(inp.value.trim().toLowerCase() === cur.hr.toLowerCase()) { challengeList.shift(); showQuestion(); } else alert('é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆ: ' + cur.hr);
    };
    function exitChallenge() { document.getElementById('challengeOverlay').style.display = 'none'; }
    function goToNotebook() { alert('è¯·é€šè¿‡é€‰æ‹©å•å…ƒåˆ‡æ¢è‡³é”™é¢˜æœ¬'); }

    if(appData.length > 0) render();
</script>
</body>
</html>
